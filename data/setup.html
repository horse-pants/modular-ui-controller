<!DOCTYPE html>
<html>
<head>
    <title>ModularUI WiFi Setup</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <script src="theme.js"></script>
</head>
<body>
    <div class="container">
        <div class="header-controls">
            <h1>WiFi Setup</h1>
            <button type="button" class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-sun"></i>
            </button>
        </div>
        <div class="scanning" id="scanning">Loading networks...</div>
        
        
        <form action="/save-wifi" method="POST">
            <label for="network_name">Host Name:</label>
            <input type="text" id="network_name" name="network_name" placeholder="Enter device host name" required>
            
            <label for="wifi_network">Available WiFi Networks:</label>
            <select id="wifi_network" name="wifi_network" required>
                <option value="">Loading...</option>
            </select>
            
            <label for="wifi_password">WiFi Password:</label>
            <input type="password" id="wifi_password" name="wifi_password" placeholder="Leave blank to keep current password">
            <p id="password_hint" style="color: #b0b0b0; font-size: 12px; margin-top: 5px; display: none;">
                Password required when changing WiFi network
            </p>
            
            <h3 style="color: #00D9FF; margin-top: 30px; margin-bottom: 15px;">LED Configuration</h3>
            
            <label for="num_strips">Number of LED Strips:</label>
            <input type="number" id="num_strips" name="num_strips" min="1" max="20" placeholder="e.g., 5" required>
            
            <label for="leds_per_strip">LEDs per Strip:</label>
            <input type="number" id="leds_per_strip" name="leds_per_strip" min="1" max="300" placeholder="e.g., 29" required>
            
            <p style="color: #b0b0b0; font-size: 14px; margin-top: 10px;">
                <strong>Total LEDs:</strong> <span id="totalLeds">0</span>
            </p>
            
            <button type="submit">Save All Settings & Restart</button>
        </form>
        
        <button type="button" class="factory-reset-btn" onclick="factoryReset()">Factory Reset WiFi Settings</button>
    </div>

    <script>
        function loadNetworks() {
            document.getElementById('scanning').style.display = 'block';
            fetch('/get-networks')
                .then(response => response.text())
                .then(data => {
                    const select = document.getElementById('wifi_network');
                    select.innerHTML = '';
                    
                    if (!data || data.trim() === '') {
                        select.innerHTML = '<option value="">No networks found</option>';
                    } else {
                        const networks = data.split(',');
                        networks.forEach(network => {
                            if (network.trim()) {
                                const parts = network.split('|');
                                if (parts.length === 2) {
                                    const ssid = parts[0];
                                    const rssi = parts[1];
                                    const option = document.createElement('option');
                                    option.value = ssid;
                                    option.textContent = `${ssid} (${rssi} dBm)`;
                                    select.appendChild(option);
                                }
                            }
                        });
                        
                        // Select current WiFi network if it exists in the list
                        if (window.currentWifiSSID) {
                            // Find option that matches the SSID (option value is just the SSID)
                            const options = select.querySelectorAll('option');
                            for (let option of options) {
                                if (option.value === window.currentWifiSSID) {
                                    select.value = window.currentWifiSSID;
                                    updatePasswordRequirement();
                                    break;
                                }
                            }
                        }
                    }
                    document.getElementById('scanning').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error loading networks:', error);
                    document.getElementById('wifi_network').innerHTML = '<option value="">Error loading networks</option>';
                    document.getElementById('scanning').style.display = 'none';
                });
        }
        
        
        // Store original values for change detection
        let originalSettings = {
            hostName: '',
            wifiSSID: '',
            numStrips: 0,
            ledsPerStrip: 0
        };
        
        function loadCurrentSettings() {
            fetch('/get-current-settings')
                .then(response => response.json())
                .then(data => {
                    // Store original values
                    originalSettings.hostName = data.networkName || '';
                    originalSettings.wifiSSID = data.wifiSSID || '';
                    originalSettings.numStrips = data.numStrips || 0;
                    originalSettings.ledsPerStrip = data.ledsPerStrip || 0;
                    
                    if (data.hasSettings) {
                        // Pre-fill WiFi form fields
                        document.getElementById('network_name').value = data.networkName || '';
                        // Set WiFi network dropdown after networks are loaded
                        window.currentWifiSSID = data.wifiSSID || '';
                    }
                    
                    // Load LED settings
                    if (data.hasLedSettings) {
                        // Pre-fill the form with current values
                        document.getElementById('num_strips').value = data.numStrips || '';
                        document.getElementById('leds_per_strip').value = data.ledsPerStrip || '';
                        updateTotalLeds();
                    }
                })
                .catch(error => {
                    console.error('Error loading current settings:', error);
                });
        }
        
        function updateTotalLeds() {
            const numStrips = parseInt(document.getElementById('num_strips').value) || 0;
            const ledsPerStrip = parseInt(document.getElementById('leds_per_strip').value) || 0;
            const total = numStrips * ledsPerStrip;
            document.getElementById('totalLeds').textContent = total;
        }
        
        function updatePasswordRequirement() {
            const selectedSSID = document.getElementById('wifi_network').value;
            const passwordField = document.getElementById('wifi_password');
            const passwordHint = document.getElementById('password_hint');
            
            // Check if we're changing the WiFi network or if no current settings exist
            const isNewNetwork = !originalSettings.wifiSSID || selectedSSID !== originalSettings.wifiSSID;
            
            if (isNewNetwork && selectedSSID) {
                // Require password for new/different networks
                passwordField.required = true;
                passwordHint.style.display = 'block';
                passwordField.placeholder = 'Password required for new network';
            } else {
                // Don't require password for same network
                passwordField.required = false;
                passwordHint.style.display = 'none';
                passwordField.placeholder = 'Leave blank to keep current password';
            }
        }
        
        function factoryReset() {
            if (confirm('Are you sure you want to reset all WiFi settings? This will clear all network preferences and restart the device.')) {
                // Create a form to POST to factory-reset endpoint
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/factory-reset';
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // Load networks and current settings when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadNetworks();
            loadCurrentSettings();
        });
        
        // Update password requirement when WiFi network changes (don't auto-fill host name)
        document.getElementById('wifi_network').addEventListener('change', function() {
            updatePasswordRequirement();
        });
        
        // Update total LEDs when inputs change
        document.getElementById('num_strips').addEventListener('input', updateTotalLeds);
        document.getElementById('leds_per_strip').addEventListener('input', updateTotalLeds);
    </script>
</body>
</html>